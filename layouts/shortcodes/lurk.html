{{ if not (.Page.Scratch.Get "lurk") }}
<script type="text/javascript" src="{{ "lurk/highlight-lisp/highlight-lisp.js" | relURL }}"></script>
<link rel="stylesheet" id="hl-theme" href="{{ "lurk/highlight-lisp/themes/github.css"  | relURL }}" >
<link rel="stylesheet" href="{{ "lurk/css/lurk.css" | relURL  }}">
<script type="module" src="{{ "lurk/index.js" | relURL }}"></script>
{{ .Page.Scratch.Set "lurk" true }}
{{ end }}

{{ $id := now.UnixNano }}
{{ $editable := .Get "editable" }}
<style>
  [contenteditable] {
    outline: 0px solid transparent;
  }

  .lurk-code-component .code-section {
    padding-top: 20px;
  }

  .lurk-code-component {
    position: relative;
  }

  .main{
    width: 600px;
  }

  #output-container{{$id}} {
    display: none;
  }

  #lurk-code-component-controls{{$id}} {
    display: block;
  }

  #run{{$id}} {
    background-repeat: no-repeat;
    background-color: rgb(104, 104, 104);
    -webkit-mask-image: url({{ "lurk/img/play-fill.svg" | relURL  }});
    mask-image: url({{ "lurk/img/play-fill.svg" | relURL  }});
    height: 16px;
    width: 16px;
    border: 0;
    box-sizing: border-box;
    transition: 100ms all ease;
    cursor: pointer;
    position: absolute;
    top: 7px;
    right: 6px;
  }

  #run{{$id}}:hover {
               -moz-box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
               -webkit-box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
               box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
             }

  #reset{{$id}} {
    background-repeat: no-repeat;
    background-color: rgb(104, 104, 104);
    -webkit-mask-image: url({{ "lurk/img/rewind-fill.svg" | relURL  }});
    mask-image: url({{ "lurk/img/rewind-fill.svg" | relURL  }});
    height: 16px;
    width: 16px;
    border: 0;
    box-sizing: border-box;
    transition: 100ms all ease;
    cursor: pointer;
    position: absolute;
    top: 7px;
    right: 26px;
  }

  #reset{{$id}}:hover {
                 -moz-box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
                 -webkit-box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
                 box-shadow: inset 0 0 100px 100px rgba(255, 255, 255, 0.3);
               }

</style>

<div id="main" width="100%" >
  <div class="lurk-code-component">
    <div id="lurk-code-component-controls{{$id}}">
      <button id="reset{{$id}}" class="button"></button>
      <button id="run{{$id}}" class="button"></button>
    </div>
    <pre class="code-section"><code id="lurkcode{{$id}}" name="lurkcode" contenteditable="{{$editable}}" class="lisp">{{ .Inner | .Page.RenderString }}</code></pre>
    <span id="output-container{{$id}}">
        <pre class="output-section"><code class="output" id="output{{$id}}" name="output">output goes here</code></pre>
      </span>
  </div>
</div>


<script type="text/javascript">

  var originalContent;
  document.getElementById("run{{$id}}").onclick = async function() {
    try{

      var lurkcode = document.getElementById("lurkcode{{$id}}");
      var output = document.getElementById("output{{$id}}");
      var output_container = document.getElementById("output-container{{$id}}");
      let textContent = lurkcode.textContent;
      originalContent = textContent;
      ab = await window.runExpressionEvaluator({textContent});
      var outObj = JSON.parse(ab);
      output.textContent = "Iterations: " + outObj.iterations + "\nResult: " + outObj.result;
      output_container.style.display = "block";

    } catch (e) {
      //  console.log(e);
    }
  };

  document.getElementById("reset{{$id}}").onclick = async function() {
    try {
      var lurkcode = document.getElementById("lurkcode{{$id}}");
      lurkcode.textContent = originalContent;
    } catch (e) {
      //  console.log(e);
    }
  };

</script>
